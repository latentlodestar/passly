default_platform(:ios)

MOBILE_DIR = File.expand_path("../../Passly.Mobile", __dir__)

platform :android do
  desc "Prebuild android/ from Expo config"
  lane :prebuild do
    sh "npx expo prebuild --platform android --clean", chdir: MOBILE_DIR
  end

  desc "Build a release AAB (expects signing props via Gradle project properties)"
  lane :build_aab do
    sh "cd android && ./gradlew clean bundleRelease", chdir: MOBILE_DIR
  end

  desc "Upload to Google Play. Set PLAY_JSON_KEY_PATH env var."
  lane :upload_play do |options|
    json_key = ENV["PLAY_JSON_KEY_PATH"]
    UI.user_error!("Set PLAY_JSON_KEY_PATH to your service account JSON path") unless json_key

    track = options[:track] || "internal"
    aab_path = options[:aab] || File.join(MOBILE_DIR, "android/app/build/outputs/bundle/release/app-release.aab")

    upload_to_play_store(
      json_key: json_key,
      package_name: "latentlodestar.passly",
      track: track,
      aab: aab_path,
      skip_upload_metadata: options.fetch(:skip_metadata, true),
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_changelogs: options.fetch(:skip_changelogs, true)
    )
  end

  desc "One command: prebuild -> build -> upload (internal by default)"
  lane :release do |options|
    prebuild
    build_aab
    upload_play(
      track: options[:track] || "internal",
      skip_metadata: options.fetch(:skip_metadata, true),
      skip_changelogs: options.fetch(:skip_changelogs, true)
    )
  end
end

platform :ios do
  desc "Prebuild ios/ from Expo config"
  lane :prebuild do
    sh "npx expo prebuild --platform ios --clean", chdir: MOBILE_DIR
  end

  desc "Fetch or create signing certificates and provisioning profiles via match"
  lane :certificates do
    match(type: "appstore")
    match(type: "development")
  end

  desc "Build a signed IPA"
  lane :build_ipa do
    gym(
      workspace: File.join(MOBILE_DIR, "ios/Passly.xcworkspace"),
      scheme: "Passly",
      export_method: "app-store",
      output_directory: File.join(MOBILE_DIR, "ios/build"),
      output_name: "Passly.ipa"
    )
  end

  desc "Upload to TestFlight"
  lane :upload_testflight do |options|
    ipa_path = options[:ipa] || File.join(MOBILE_DIR, "ios/build/Passly.ipa")

    pilot(
      ipa: ipa_path,
      skip_waiting_for_build_processing: true
    )
  end

  desc "One command: prebuild -> certificates -> build -> upload"
  lane :release do
    prebuild
    certificates
    build_ipa
    upload_testflight
  end
end
