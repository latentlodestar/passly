default_platform(:android)

platform :android do
  desc "Prebuild android/ from Expo config"
  lane :prebuild do
    sh "npx expo prebuild --platform android --clean"
  end

  desc "Build a release AAB (expects signing props via Gradle project properties)"
  lane :build_aab do
    sh "cd android && ./gradlew clean bundleRelease"
    UI.message("AAB: android/app/build/outputs/bundle/release/app-release.aab")
  end

  desc "Upload to Google Play (metadata and/or AAB). Set PLAY_JSON_KEY_PATH env var."
  lane :upload_play do |options|
    json_key = ENV["PLAY_JSON_KEY_PATH"]
    UI.user_error!("Set PLAY_JSON_KEY_PATH to your service account JSON path") unless json_key

    track = options[:track] || "internal"
    aab_path = options[:aab] || "android/app/build/outputs/bundle/release/app-release.aab"

    upload_to_play_store(
      json_key: json_key,
      package_name: "latentlodestar.sayitnow",
      track: track,
      aab: aab_path,

      # For first-time setup, you can skip metadata/images until later:
      skip_upload_metadata: options.fetch(:skip_metadata, true),
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_changelogs: options.fetch(:skip_changelogs, true)
    )
  end

  desc "One command: prebuild -> build -> upload (internal by default)"
  lane :release do |options|
    prebuild
    build_aab
    upload_play(
      track: options[:track] || "internal",
      skip_metadata: options.fetch(:skip_metadata, true),
      skip_changelogs: options.fetch(:skip_changelogs, true)
    )
  end
end
